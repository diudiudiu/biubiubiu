# 性能优化

前端的性能优化是很重要的，一个页面通过优化，使响应时间减少幅度通常为25%或者更高。

## 减少请求资源大小或者次数　

1. ### webpack，gulp 等打包工具打包

   将css文件和并为一个，将js合并为一个，减少http请求次数以及减少请求资源的大小。

2. 使用的字体图标或者SVG图标来代替传统png图

   字体图标或者SVG是矢量图，方大不会变形，渲染速度快。

3. html-minifier等进行html压缩

   HTML中不显示的字符，包括空格、制表符、换行符、注释等。

4. 懒加载和预加载

   减少页面第一次加载过程中http的请求次数。

   预加载

   - 图片等静态资源在使用之前的提前请求
   - 资源使用到时能从缓存中加载，提升用户体验

   懒加载（延迟加载）

   - 页面开始加载时不去发送http请求，而是放置一张占位图。
   - 当页面加载完时，并且图片在可视区域再去请求加载图片信息。

5. 图片精灵

   把所有相对较小的资源图片，绘制在一张大图上，然后利用图片定位来讲小图展现在页面中。

6. 避免使用iframe

   不好管控样式，相当于在本页面嵌套其他页面，消耗性能会更大，还会去加载这个嵌套页面的资源。

## 代码优化

1. 避免重绘和重排（回流）

   重排是DOM元素的几何属性变化，DOM树的结构变化，渲染树需要重新计算。
   重绘是浏览器会根据元素的新属性重新绘制，使元素呈现新的外观。
   重绘不会引起重排，但重排一定会引起重绘，一个元素的重排通常会带来一系列的反应，甚至触发整个文档的重排和重绘，性能代价是高昂的。

   那么，什么情况下会触发重排？

   一般是DOM元素在标准流中，自身大小或者增加删除DOM 元素，引起的后续元素位置和布局发生改变。

   - 页面渲染初始化时
   - 浏览器窗口改变尺寸
   - 元素尺寸改变时
   - 元素位置改变时
   - 元素内容改变时
   - 添加或删除可见的DOM 元素时

   重排优化

   - 将多次改变样式属性的操作合并成一次操作，减少DOM访问。
   - 如果要批量添加DOM，可以先让元素脱离文档流，操作完后再带入文档流，这样只会触发一次重排。（fragment元素的应用）
   - 将需要多次重排的元素，position属性设为absolute或fixed，这样此元素就脱离了文档流，它的变化不会影响到其他元素。例如有动画效果的元素就最好设置为绝对定位。
   - 由于display属性为none的元素不在渲染树中，对隐藏的元素操作不会引发其他元素的重排。如果要对一个元素进行复杂的操作时，可以先隐藏它，操作完成后再显示。这样只在隐藏和显示时触发两次重排。
   - 在内存中多次操作节点，完成后再添加到文档中去。例如要异步获取表格数据，渲染到页面。可以先取得数据后在内存中构建整个表格的html片段，再一次性添加到文档中去，而不是循环添加每一行。

   

2. 在js中尽量减少闭包的使用

   使用闭包后，闭包所在的上下文不会被释放。

3. 非核心代码异步加载

   基于script标签下载js文件时，可以使用defer或者async来异步加载。

4. 事件委托

   在事件绑定中，尽可能使用事件委托，减少循环给DOM元素绑定事件处理函数。

5. 减少DNS查找

   减少唯一主机数量，会潜在的减少页面中并行下载的数量。

## 存储缓存

### 结合后端缓存

避免向后台请求数据或者说在离线状态下做一些数据展示。

#### cookie sessionStorage和localstorage存储及区别。

相同点：都存储在客户端

不同点：

1. 存储大小
   cookie数据大小不能超过4k。
   sessionStorage和localStorage 虽然也有存储大小的限制，但比cookie大得多，可以达到5M或更大。

2. 有效时间

   localStorage    存储持久数据，浏览器关闭后数据不丢失除非主动删除数据；
   sessionStorage  数据在当前浏览器窗口关闭后自动删除。
   cookie          设置的cookie过期时间之前一直有效，即使窗口或浏览器关闭


3. 数据与服务器之间的交互方式
   cookie的数据会自动的传递到服务器，服务器端也可以写cookie到客户端
   sessionStorage和localStorage不会自动把数据发给服务器，仅在本地保存。

#### cookie 涉及到 http 在这里重点介绍一下

- 因为 http 请求无状态，所以需要 cookie 去维持客户端状态 现在有用 token 的

- cookie 生成方式：http response header 中的 set-cookie 

  ​							js 中可以通过document.cookie读写cookie

- 过期时间：expire设置的cookie过期时间之前一直有效

- cdn 的域名和主站的域名要分开，可以解决 cookie 中在相关域名下 cdn的流量损耗 